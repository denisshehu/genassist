# Template: Deploy services using docker-compose on self-hosted agent
# Used by both DEV and TEST stages with different envFile parameters.
parameters:
  - name: services
    type: string
    displayName: 'Services to deploy (space-separated)'
  - name: envFile
    type: string
    displayName: 'Secure file name for environment variables'
  - name: envDest
    type: string
    displayName: 'Destination path for .env file (e.g., backend/.env or frontend/.env)'
  - name: composeOverride
    type: string
    default: 'docker-compose.yml'
    displayName: 'Compose override file (docker-compose.yml or docker-compose.build.yml)'
  - name: extraEnv
    type: string
    default: ''
    displayName: 'Extra environment variables to append (e.g., VITE_UI_VERSION=1.0)'
  - name: cleanupExtra
    type: string
    default: 'db redis chroma qdrant'
    displayName: 'Additional services to clean up (infrastructure dependencies). Set to empty for frontend-only deploys.'
  - name: noDeps
    type: boolean
    default: false
    displayName: 'Skip starting dependency services (use for frontend-only deploys)'

steps:
  - task: DownloadSecureFile@1
    name: envfile
    displayName: 'Download .env file'
    inputs:
      secureFile: ${{ parameters.envFile }}

  - script: |
      set -euo pipefail

      echo "=== Preparing environment ==="
      cp "$(envfile.secureFilePath)" ${{ parameters.envDest }}
      EXTRA_ENV="${{ parameters.extraEnv }}"
      if [ -n "$EXTRA_ENV" ]; then
        # Remove existing keys so the extra values take precedence
        # (dotenv uses first occurrence, so appending alone won't override)
        for pair in $EXTRA_ENV; do
          KEY=$(echo "$pair" | cut -d= -f1)
          sed -i "/^${KEY}=/d" ${{ parameters.envDest }}
        done
        for pair in $EXTRA_ENV; do
          printf '\n%s' "$pair" >> ${{ parameters.envDest }}
        done
        printf '\n' >> ${{ parameters.envDest }}
      fi

      # Ensure both env files exist so compose can parse the full file
      # (needed when deploying frontend-only without backend/.env present)
      mkdir -p backend frontend
      [ -f backend/.env ] || touch backend/.env
      [ -f frontend/.env ] || touch frontend/.env

      echo "=== Cleaning up orphaned containers ==="
      CLEANUP_TARGETS="${{ parameters.services }} ${{ parameters.cleanupExtra }}"
      for svc in $CLEANUP_TARGETS; do
        [ -z "$svc" ] && continue
        cids=$(docker ps -aq --filter "name=genassist" | while read cid; do
          cname=$(docker inspect --format '{{.Name}}' "$cid" 2>/dev/null | tr -d '/')
          echo "$cname" | grep -q "$svc" && echo "$cid"
        done || true)
        if [ -n "$cids" ]; then
          echo "Removing orphaned containers for $svc: $cids"
          echo "$cids" | xargs docker rm -f 2>/dev/null || true
        fi
      done

      echo "=== Stopping target services ==="
      docker compose -f docker/docker-compose.base.yml -f docker/${{ parameters.composeOverride }} stop ${{ parameters.services }} || true
      docker compose -f docker/docker-compose.base.yml -f docker/${{ parameters.composeOverride }} rm -f ${{ parameters.services }} || true

      echo "=== Pulling latest images ==="
      docker compose -f docker/docker-compose.base.yml -f docker/${{ parameters.composeOverride }} pull ${{ parameters.services }} || true

      NO_DEPS_FLAG=""
      if [ "${{ parameters.noDeps }}" = "True" ]; then
        NO_DEPS_FLAG="--no-deps"
      fi

      echo "=== Deploying services: ${{ parameters.services }} ==="
      docker compose -f docker/docker-compose.base.yml -f docker/${{ parameters.composeOverride }} up -d --build --force-recreate --remove-orphans $NO_DEPS_FLAG ${{ parameters.services }}

      echo "=== Verifying deployment ==="
      docker compose -f docker/docker-compose.base.yml -f docker/${{ parameters.composeOverride }} ps
    displayName: 'Deploy ${{ parameters.services }}'
