# Template: Deploy services using docker-compose on self-hosted agent
# Used by both DEV and TEST stages with different envFile parameters.
parameters:
  - name: services
    type: string
    displayName: 'Services to deploy (space-separated)'
  - name: envFile
    type: string
    displayName: 'Secure file name for environment variables'
  - name: envDest
    type: string
    displayName: 'Destination path for .env file (e.g., backend/.env or frontend/.env)'
  - name: composeOverride
    type: string
    default: 'docker-compose.yml'
    displayName: 'Compose override file (docker-compose.yml or docker-compose.build.yml)'
  - name: extraEnv
    type: string
    default: ''
    displayName: 'Extra environment variables to append (e.g., VITE_UI_VERSION=1.0)'

steps:
  - task: DownloadSecureFile@1
    name: envfile
    displayName: 'Download .env file'
    inputs:
      secureFile: ${{ parameters.envFile }}

  - script: |
      set -euo pipefail

      echo "=== Preparing environment ==="
      cp "$(envfile.secureFilePath)" ${{ parameters.envDest }}
      EXTRA_ENV="${{ parameters.extraEnv }}"
      if [ -n "$EXTRA_ENV" ]; then
        echo "$EXTRA_ENV" >> ${{ parameters.envDest }}
      fi

      echo "=== Cleaning up orphaned containers ==="
      for svc in ${{ parameters.services }}; do
        [ -z "$svc" ] && continue
        cids=$(docker ps -aq --filter "name=genassist" | while read cid; do
          cname=$(docker inspect --format '{{.Name}}' "$cid" 2>/dev/null | tr -d '/')
          echo "$cname" | grep -q "$svc" && echo "$cid"
        done || true)
        if [ -n "$cids" ]; then
          echo "Removing orphaned containers for $svc: $cids"
          echo "$cids" | xargs docker rm -f 2>/dev/null || true
        fi
      done

      echo "=== Stopping target services ==="
      docker compose -f docker/docker-compose.base.yml -f docker/${{ parameters.composeOverride }} stop ${{ parameters.services }} || true
      docker compose -f docker/docker-compose.base.yml -f docker/${{ parameters.composeOverride }} rm -f ${{ parameters.services }} || true

      echo "=== Pulling latest images ==="
      docker compose -f docker/docker-compose.base.yml -f docker/${{ parameters.composeOverride }} pull ${{ parameters.services }} || true

      echo "=== Deploying services: ${{ parameters.services }} ==="
      docker compose -f docker/docker-compose.base.yml -f docker/${{ parameters.composeOverride }} up -d --build --force-recreate --remove-orphans ${{ parameters.services }}

      echo "=== Verifying deployment ==="
      docker compose -f docker/docker-compose.base.yml -f docker/${{ parameters.composeOverride }} ps
    displayName: 'Deploy ${{ parameters.services }}'
