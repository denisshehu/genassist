# Template: Build and push image to registry
# No env injection needed â€” backend reads .env at runtime, frontend uses
# placeholder substitution via entrypoint.sh at container startup.
parameters:
  - name: composeService
    type: string
    displayName: 'Docker compose service name (e.g., app, ui)'
  - name: localImageName
    type: string
    displayName: 'Local image name after compose build (e.g., genassist-app-image, genassist-ui)'
  - name: registryImageName
    type: string
    displayName: 'Registry image name (e.g., genassist-backend, genassist-frontend)'

steps:
  - script: |
      set -euo pipefail
      echo "=== Logging in to GHCR ==="
      echo "$(GHCR_PAT)" | docker login ghcr.io -u "$(GHCR_USER)" --password-stdin
    displayName: 'Login to GHCR'

  - script: |
      set -euo pipefail

      echo "=== Building ${{ parameters.composeService }} ==="
      docker compose -f docker/docker-compose.base.yml -f docker/docker-compose.build.yml build ${{ parameters.composeService }}
      docker image ls

      echo "=== Tagging ==="
      docker image tag ${{ parameters.localImageName }}:latest ghcr.io/ritechsolutions/${{ parameters.registryImageName }}:$(Build.BuildNumber)
      docker image tag ${{ parameters.localImageName }}:latest ghcr.io/ritechsolutions/${{ parameters.registryImageName }}:latest

      echo "=== Pushing ==="
      docker push ghcr.io/ritechsolutions/${{ parameters.registryImageName }}:$(Build.BuildNumber)
      docker push ghcr.io/ritechsolutions/${{ parameters.registryImageName }}:latest

      echo "=== Done ==="
    displayName: 'Build & Push ${{ parameters.registryImageName }}'
