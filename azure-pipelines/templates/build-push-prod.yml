# Template: Build and push image to PROD registry path (with env vars)
parameters:
  - name: composeService
    type: string
    displayName: 'Docker compose service name (e.g., app, ui)'
  - name: localImageName
    type: string
    displayName: 'Local image name after compose build (e.g., genassist-app-image, genassist-ui)'
  - name: registryImageName
    type: string
    displayName: 'Registry image name (e.g., genassist-backend, genassist-frontend)'
  - name: envFile
    type: string
    default: 'env.prod'
    displayName: 'Secure file name for environment variables'

steps:
  - task: DownloadSecureFile@1
    name: prodenv
    displayName: 'Download PROD .env file'
    inputs:
      secureFile: ${{ parameters.envFile }}

  - script: |
      set -euo pipefail

      echo "=== Preparing PROD environment ==="
      cp "$(prodenv.secureFilePath)" backend/.env
      cp "$(prodenv.secureFilePath)" frontend/.env

      echo "=== Building ${{ parameters.composeService }} ==="
      docker compose -p genassist -f docker/docker-compose.base.yml -f docker/docker-compose.dev.yml build ${{ parameters.composeService }}
      docker image ls

      echo "=== Tagging for PROD ==="
      docker image tag ${{ parameters.localImageName }}:latest ghcr.io/ritechsolutions/genassist/prod/${{ parameters.registryImageName }}:$(Build.BuildNumber)
      docker image tag ${{ parameters.localImageName }}:latest ghcr.io/ritechsolutions/genassist/prod/${{ parameters.registryImageName }}:latest
      docker image tag ${{ parameters.localImageName }}:latest ghcr.io/ritechsolutions/genassist/prod/${{ parameters.registryImageName }}:prod

      echo "=== Pushing to PROD ==="
      docker push ghcr.io/ritechsolutions/genassist/prod/${{ parameters.registryImageName }}:$(Build.BuildNumber)
      docker push ghcr.io/ritechsolutions/genassist/prod/${{ parameters.registryImageName }}:latest
      docker push ghcr.io/ritechsolutions/genassist/prod/${{ parameters.registryImageName }}:prod

      echo "=== Done ==="
    displayName: 'Build & Push ${{ parameters.registryImageName }} to PROD'
