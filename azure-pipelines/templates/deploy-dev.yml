# Template: Deploy to DEV environment using docker-compose on self-hosted agent
parameters:
  - name: services
    type: string
    displayName: 'Services to deploy (space-separated)'
  - name: envFile
    type: string
    default: 'env.dev'
    displayName: 'Secure file name for environment variables'

steps:
  - task: DownloadSecureFile@1
    name: devenv
    displayName: 'Download DEV .env file'
    inputs:
      secureFile: ${{ parameters.envFile }}

  - script: |
      set -euo pipefail

      echo "=== Preparing environment ==="
      cp "$(devenv.secureFilePath)" backend/.env
      cp "$(devenv.secureFilePath)" frontend/.env

      echo "=== Stopping existing containers ==="
      docker compose -f docker/docker-compose.base.yml -f docker/docker-compose.yml down --remove-orphans || true

      echo "=== Pulling latest images ==="
      docker compose -f docker/docker-compose.base.yml -f docker/docker-compose.yml pull ${{ parameters.services }} || true

      echo "=== Starting services: ${{ parameters.services }} ==="
      docker compose -f docker/docker-compose.base.yml -f docker/docker-compose.yml up -d --build ${{ parameters.services }}

      echo "=== Verifying deployment ==="
      docker compose -f docker/docker-compose.base.yml -f docker/docker-compose.yml ps
    displayName: 'Deploy ${{ parameters.services }} to DEV'
