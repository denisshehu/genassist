# Release Pipeline: Backend Services
# Deploys: app, celery_worker, celery_beat, whisper, flower

name: Backend_$(Date:yyyyMMdd)$(Rev:.r)

trigger: none

  # GHCR_USER and GHCR_PAT must be set as secret variables in the pipeline settings UI

parameters:
  - name: deployToDev
    type: boolean
    default: true
    displayName: 'Deploy to DEV'
  - name: deployToTest
    type: boolean
    default: false
    displayName: 'Deploy to TEST'
  - name: deployToProd
    type: boolean
    default: false
    displayName: 'Deploy to PROD'
  - name: includeInfra
    type: boolean
    default: false
    displayName: 'Include infrastructure services (db, redis, chroma, qdrant)'
  - name: includeCelery
    type: boolean
    default: true
    displayName: 'Include Celery services (celery_worker, celery_beat)'
  - name: includeWhisper
    type: boolean
    default: true
    displayName: 'Include Whisper service'
  - name: includeFlower
    type: boolean
    default: true
    displayName: 'Include Flower service'

variables:
  ${{ if eq(parameters.includeInfra, true) }}:
    infraPart: 'db redis chroma qdrant'
  ${{ else }}:
    infraPart: ''
  ${{ if eq(parameters.includeCelery, true) }}:
    celeryPart: 'celery_worker celery_beat'
  ${{ else }}:
    celeryPart: ''
  ${{ if eq(parameters.includeWhisper, true) }}:
    whisperPart: 'whisper'
  ${{ else }}:
    whisperPart: ''
  ${{ if eq(parameters.includeFlower, true) }}:
    flowerPart: 'flower'
  ${{ else }}:
    flowerPart: ''

stages:
  # ═══════════════════════════════════════════════════════════════════════════
  # DEV: Deploy to self-hosted agent using docker-compose
  # ═══════════════════════════════════════════════════════════════════════════
  - stage: DEV
    displayName: 'Deploy to DEV'
    condition: eq('${{ parameters.deployToDev }}', true)
    jobs:
      - deployment: DeployBackend
        displayName: 'Deploy Backend Services'
        environment: 'genassist-dev'
        pool:
          name: 'Ritech-AI-TR1'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  clean: true

                - template: templates/deploy.yml
                  parameters:
                    services: '$(infraPart) app $(celeryPart) $(whisperPart) $(flowerPart)'
                    composeOverride: 'docker-compose.build.yml'
                    envFile: 'env.backend.dev'
                    envDest: 'backend/.env'
                    extraEnv: 'API_VERSION=$(Build.BuildNumber)'

  # ═══════════════════════════════════════════════════════════════════════════
  # TEST: Build, push to GHCR, and deploy on the build server
  # ═══════════════════════════════════════════════════════════════════════════
  - stage: TEST
    displayName: 'Build, Push & Deploy to TEST'
    dependsOn: DEV
    condition: |
      and(
        eq('${{ parameters.deployToTest }}', true),
        or(succeeded(), eq('${{ parameters.deployToDev }}', false))
      )
    jobs:
      - deployment: BuildPushDeployBackend
        displayName: 'Build, Push & Deploy Backend'
        environment: 'genassist-test'
        pool:
          name: 'Ritech-AI-TR1'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  clean: true

                - template: templates/build-push-test.yml
                  parameters:
                    composeService: 'app'
                    localImageName: 'genassist-app-image'
                    registryImageName: 'genassist-backend'

                - ${{ if eq(parameters.includeWhisper, true) }}:
                  - template: templates/build-push-test.yml
                    parameters:
                      composeService: 'whisper'
                      localImageName: 'genassist-whisper'
                      registryImageName: 'genassist-whisper'

                - template: templates/deploy.yml
                  parameters:
                    services: '$(infraPart) app $(celeryPart) $(whisperPart) $(flowerPart)'
                    envFile: 'env.backend.test'
                    envDest: 'backend/.env'
                    extraEnv: 'API_VERSION=$(Build.SourceBranchName)-$(Build.BuildNumber)'

  # ═══════════════════════════════════════════════════════════════════════════
  # PROD: Promote tested image to prod registry (no rebuild)
  # ═══════════════════════════════════════════════════════════════════════════
  - stage: PROD
    displayName: 'Promote to PROD'
    dependsOn: TEST
    condition: |
      and(
        eq('${{ parameters.deployToProd }}', true),
        or(succeeded(), eq('${{ parameters.deployToTest }}', false))
      )
    jobs:
      - deployment: PromoteProdBackend
        displayName: 'Promote Backend to PROD'
        environment: 'genassist-production'
        pool:
          name: 'Ritech-AI-TR1'
        strategy:
          runOnce:
            deploy:
              steps:
                - template: templates/promote-to-prod.yml
                  parameters:
                    registryImageName: 'genassist-backend'

                - ${{ if eq(parameters.includeWhisper, true) }}:
                  - template: templates/promote-to-prod.yml
                    parameters:
                      registryImageName: 'genassist-whisper'
