# Release Pipeline: Frontend Service
# Deploys: ui

name: Frontend_$(Date:yyyyMMdd)$(Rev:.r)

trigger: none

  # GHCR_USER and GHCR_PAT must be set as secret variables in the pipeline settings UI

parameters:
  - name: deployToDev
    type: boolean
    default: true
    displayName: 'Deploy to DEV'
  - name: deployToTest
    type: boolean
    default: false
    displayName: 'Deploy to TEST'
  - name: deployToProd
    type: boolean
    default: false
    displayName: 'Deploy to PROD'

stages:
  # ═══════════════════════════════════════════════════════════════════════════
  # DEV: Deploy to self-hosted agent using docker-compose
  # ═══════════════════════════════════════════════════════════════════════════
  - stage: DEV
    displayName: 'Deploy to DEV'
    condition: eq('${{ parameters.deployToDev }}', true)
    jobs:
      - deployment: DeployFrontend
        displayName: 'Deploy Frontend Service'
        environment: 'genassist-dev'
        pool:
          name: 'Ritech-AI-TR1'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  clean: true

                - template: templates/deploy.yml
                  parameters:
                    services: 'ui'
                    composeOverride: 'docker-compose.build.yml'
                    envFile: 'env.frontend.dev'
                    envDest: 'frontend/.env'
                    extraEnv: 'VITE_UI_VERSION=$(Build.BuildNumber)'

  # ═══════════════════════════════════════════════════════════════════════════
  # TEST: Build, push to GHCR, and deploy on the build server
  # ═══════════════════════════════════════════════════════════════════════════
  - stage: TEST
    displayName: 'Build, Push & Deploy to TEST'
    dependsOn: DEV
    condition: |
      and(
        eq('${{ parameters.deployToTest }}', true),
        or(succeeded(), eq('${{ parameters.deployToDev }}', false))
      )
    jobs:
      - deployment: BuildPushDeployFrontend
        displayName: 'Build, Push & Deploy Frontend'
        environment: 'genassist-test'
        pool:
          name: 'Ritech-AI-TR1'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  clean: true

                - template: templates/build-push-test.yml
                  parameters:
                    composeService: 'ui'
                    localImageName: 'genassist-ui'
                    registryImageName: 'genassist-frontend'

                - template: templates/deploy.yml
                  parameters:
                    services: 'ui'
                    envFile: 'env.frontend.test'
                    envDest: 'frontend/.env'
                    extraEnv: 'VITE_UI_VERSION=$(Build.BuildNumber)'

  # ═══════════════════════════════════════════════════════════════════════════
  # PROD: Promote tested image to prod registry (no rebuild)
  # ═══════════════════════════════════════════════════════════════════════════
  - stage: PROD
    displayName: 'Promote to PROD'
    dependsOn: TEST
    condition: |
      and(
        eq('${{ parameters.deployToProd }}', true),
        or(succeeded(), eq('${{ parameters.deployToTest }}', false))
      )
    jobs:
      - deployment: PromoteProdFrontend
        displayName: 'Promote Frontend to PROD'
        environment: 'genassist-production'
        pool:
          name: 'Ritech-AI-TR1'
        strategy:
          runOnce:
            deploy:
              steps:
                - template: templates/promote-to-prod.yml
                  parameters:
                    registryImageName: 'genassist-frontend'
