# =============================================================================
# GenAssist Docker Compose - Production Overrides
# =============================================================================
# Production-specific configuration using pre-built images from GHCR. Use with base file:
#
#   docker compose -f docker/docker-compose.base.yml -f docker/docker-compose.yml --profile full up -d
#   docker compose -f docker/docker-compose.base.yml -f docker/docker-compose.yml --profile backend up -d
#
# Or use Make: make prod
# =============================================================================

name: genassist

services:
  # ===========================================================================
  # INIT SERVICES
  # ===========================================================================
  volume-init:
    container_name: genassist-volume-init
    volumes:
      - app_data_volume:/data
    networks:
      - genassist-network

  # ===========================================================================
  # CORE INFRASTRUCTURE
  # ===========================================================================
  db:
    image: postgres:17
    container_name: genassist-db
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ../scripts/db_init_scripts:/docker-entrypoint-initdb.d
    ports:
      - "${DB_PORT_EXTERNAL:-5432}:5432"
    networks:
      - genassist-network

  redis:
    container_name: genassist-redis
    ports:
      - "${REDIS_PORT_EXTERNAL:-6379}:6379"
    networks:
      - genassist-network

  # ===========================================================================
  # VECTOR DATABASES
  # ===========================================================================
  chroma:
    image: ghcr.io/chroma-core/chroma:${CHROMA_VERSION:-1.3.7}
    container_name: genassist-chroma
    ports:
      - "${CHROMA_PORT_EXTERNAL:-8005}:8000"
    volumes:
      - chroma_data:/chroma/chroma
    environment:
      CHROMA_DB_IMPL: duckdb+parquet
      CHROMA_PERSIST_DIRECTORY: /chroma/chroma
    networks:
      - genassist-network

  qdrant:
    container_name: genassist-qdrant
    ports:
      - "${QDRANT_PORT_EXTERNAL:-6333}:6333"
      - "${QDRANT_GRPC_PORT_EXTERNAL:-6334}:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - genassist-network

  # ===========================================================================
  # ML SERVICES
  # ===========================================================================
  whisper:
    image: ${WHISPER_IMAGE:-ghcr.io/ritechsolutions/genassist-whisper:latest}
    container_name: genassist-whisper
    ports:
      - "${WHISPER_PORT_EXTERNAL:-8001}:8001"
    networks:
      - genassist-network

  # ===========================================================================
  # BACKEND APPLICATION
  # ===========================================================================
  app:
    image: ${APP_IMAGE:-ghcr.io/ritechsolutions/genassist-backend:latest}
    container_name: genassist-app
    ports:
      - "${APP_PORT_EXTERNAL:-8000}:8000"
    environment:
      WORKERS: ${WORKERS:-1}
      CHROMA_PERSIST_DIR: /src/datavolume/chroma
      CHROMA_HOST: ${CHROMA_HOST:-chroma}
      CHROMA_PORT: ${CHROMA_PORT:-8005}
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-5432}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      QDRANT_HOST: ${QDRANT_HOST:-http://qdrant}
      QDRANT_PORT: ${QDRANT_PORT:-6333}
      WHISPER_TRANSCRIBE_SERVICE: ${WHISPER_TRANSCRIBE_SERVICE:-http://whisper:8001/transcribe}
    volumes:
      - app_data_volume:/src/datavolume
    networks:
      - genassist-network

  # ===========================================================================
  # CELERY WORKERS
  # ===========================================================================
  celery_worker:
    image: ${APP_IMAGE:-ghcr.io/ritechsolutions/genassist-backend:latest}
    container_name: genassist-celery-worker
    command: celery -A app.tasks.celery_app worker --loglevel=info
    networks:
      - genassist-network

  celery_beat:
    image: ${APP_IMAGE:-ghcr.io/ritechsolutions/genassist-backend:latest}
    container_name: genassist-celery-beat
    command: celery -A app.tasks.celery_app beat --loglevel=info
    networks:
      - genassist-network

  # ===========================================================================
  # FRONTEND
  # ===========================================================================
  ui:
    image: ${UI_IMAGE:-ghcr.io/ritechsolutions/genassist-frontend:latest}
    container_name: genassist-ui
    ports:
      - "${UI_PORT_EXTERNAL:-8080}:8080"
      - "${UI_HTTP_PORT_EXTERNAL:-80}:80"
    networks:
      - genassist-network

  # ===========================================================================
  # MONITORING
  # ===========================================================================
  flower:
    image: ${APP_IMAGE:-ghcr.io/ritechsolutions/genassist-backend:latest}
    container_name: genassist-flower
    command: celery -A app.tasks.celery_app flower --port=5555 --persistent=True --db="flower_db" --basic-auth="${FLOWER_USER:-user1}:${FLOWER_PASSWORD:-password1}"
    ports:
      - "${FLOWER_PORT_EXTERNAL:-5555}:5555"
    networks:
      - genassist-network

  metabase:
    container_name: genassist-metabase
    volumes:
      - ../metabase-data:/data
    ports:
      - "${METABASE_PORT_EXTERNAL:-3000}:3000"
    environment:
      MB_DB_HOST: ${MB_DB_HOST:-db}
    networks:
      - genassist-network

networks:
  genassist-network:
    driver: bridge

volumes:
  pgdata:
    name: genassist_pgdata
  chroma_data:
    name: genassist_chroma_data
  qdrant_data:
    name: genassist_qdrant_data
  app_data_volume:
    name: genassist_app_data
