# =============================================================================
# GenAssist Docker Compose - Development Overrides
# =============================================================================
# Development-specific configuration. Use with base file:
#
#   docker compose -f docker/docker-compose.base.yml -f docker/docker-compose.dev.yml --profile full up -d --build
#   docker compose -f docker/docker-compose.base.yml -f docker/docker-compose.dev.yml up -d db redis chroma qdrant whisper
#
# Or use Make: make dev
# =============================================================================

name: genassist-dev

services:
  # ===========================================================================
  # INIT SERVICES
  # ===========================================================================
  volume-init:
    container_name: genassist-volume-init-dev
    volumes:
      - app_data_volume_dev:/data
    networks:
      - genassist-network-dev

  # ===========================================================================
  # CORE INFRASTRUCTURE
  # ===========================================================================
  db:
    image: pgvector/pgvector:pg17
    container_name: genassist-db-dev
    volumes:
      - pgdata_dev:/var/lib/postgresql/data
      - ../backend/scripts/db_init_scripts:/docker-entrypoint-initdb.d
    ports:
      - "${DB_PORT_EXTERNAL:-5432}:5432"
    networks:
      - genassist-network-dev

  redis:
    container_name: genassist-redis-dev
    ports:
      - "${REDIS_PORT_EXTERNAL:-6379}:6379"
    networks:
      - genassist-network-dev

  # ===========================================================================
  # VECTOR DATABASES
  # ===========================================================================
  chroma:
    image: ghcr.io/chroma-core/chroma:${CHROMA_VERSION:-1.3.7}
    container_name: genassist-chroma-dev
    ports:
      - "${CHROMA_PORT_EXTERNAL:-8005}:8000"
    volumes:
      - chroma_data_dev:/chroma/chroma
    environment:
      CHROMA_DB_IMPL: duckdb+parquet
      CHROMA_PERSIST_DIRECTORY: /chroma/chroma
    networks:
      - genassist-network-dev

  qdrant:
    container_name: genassist-qdrant-dev
    ports:
      - "${QDRANT_PORT_EXTERNAL:-6333}:6333"
      - "${QDRANT_GRPC_PORT_EXTERNAL:-6334}:6334"
    volumes:
      - qdrant_data_dev:/qdrant/storage
    networks:
      - genassist-network-dev

  # ===========================================================================
  # ML SERVICES
  # ===========================================================================
  whisper:
    build:
      context: ../backend
      dockerfile: ./whisper_ext/Dockerfile.whisper
    image: genassist-whisper:dev
    pull_policy: never
    container_name: genassist-whisper-dev
    ports:
      - "${WHISPER_PORT_EXTERNAL:-8001}:8001"
    networks:
      - genassist-network-dev

  # ===========================================================================
  # BACKEND APPLICATION
  # ===========================================================================
  app:
    build:
      context: ../backend
      dockerfile: Dockerfile
    image: genassist-app-image:dev
    pull_policy: never
    container_name: genassist-app-dev
    ports:
      - "${APP_PORT_EXTERNAL:-8000}:8000"
    environment:
      WORKERS: ${WORKERS:-1}
      CHROMA_PERSIST_DIR: /src/datavolume/chroma
      CHROMA_HOST: ${CHROMA_HOST:-chroma}
      CHROMA_PORT: ${CHROMA_PORT:-8005}
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-5432}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      QDRANT_HOST: ${QDRANT_HOST:-http://qdrant}
      QDRANT_PORT: ${QDRANT_PORT:-6333}
      WHISPER_TRANSCRIBE_SERVICE: ${WHISPER_TRANSCRIBE_SERVICE:-http://whisper:8001/transcribe}
    depends_on:
      qdrant:
        condition: service_started
      db:
        condition: service_healthy
    volumes:
      - app_data_volume_dev:/src/datavolume
    networks:
      - genassist-network-dev

  # ===========================================================================
  # CELERY WORKERS
  # ===========================================================================
  celery_worker:
    image: genassist-app-image:dev
    pull_policy: never
    container_name: genassist-celery-worker-dev
    command: python /src/run_celery.py worker -l DEBUG
    environment:
      CELERY_TRACE_APP: 1
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-5432}
      WHISPER_TRANSCRIBE_SERVICE: ${WHISPER_TRANSCRIBE_SERVICE:-http://whisper:8001/transcribe}
    depends_on:
      app:
        condition: service_started
    networks:
      - genassist-network-dev

  celery_beat:
    image: genassist-app-image:dev
    pull_policy: never
    container_name: genassist-celery-beat-dev
    command: python /src/run_celery.py beat -l DEBUG
    environment:
      CELERY_TRACE_APP: 1
    depends_on:
      app:
        condition: service_started
    networks:
      - genassist-network-dev

  # ===========================================================================
  # FRONTEND
  # ===========================================================================
  ui:
    build:
      context: ../frontend
      dockerfile: Dockerfile
      additional_contexts:
        plugins: ../plugins/react
    image: genassist-ui-image:dev
    pull_policy: never
    container_name: genassist-ui-dev
    ports:
      - "${UI_PORT_EXTERNAL:-8080}:8080"
      - "${UI_HTTP_PORT_EXTERNAL:-80}:80"
    networks:
      - genassist-network-dev

  # ===========================================================================
  # MONITORING
  # ===========================================================================
  flower:
    image: genassist-app-image:dev
    pull_policy: never
    container_name: genassist-flower-dev
    command: python /src/run_celery.py flower -l DEBUG --port=5555 --persistent=True --db="flower_db" --basic-auth="${FLOWER_USER:-user1}:${FLOWER_PASSWORD:-password1}"
    ports:
      - "${FLOWER_PORT_EXTERNAL:-5555}:5555"
    depends_on:
      app:
        condition: service_started
    networks:
      - genassist-network-dev

  metabase:
    container_name: genassist-metabase-dev
    volumes:
      - ../metabase-data:/data
    ports:
      - "${METABASE_PORT_EXTERNAL:-3000}:3000"
    environment:
      MB_DB_HOST: ${MB_DB_HOST:-db}
    networks:
      - genassist-network-dev

  # ===========================================================================
  # TESTING
  # ===========================================================================
  uitests:
    build:
      context: ../ui_tests
      dockerfile: Dockerfile
    image: genassist-uitests:dev
    container_name: genassist-uitests-dev
    profiles: ["testing"]
    environment:
      BASE_URL: ${UITESTS_BASE_URL:-http://host.docker.internal}
      PLAYWRIGHT_HEADLESS: "true"
      CI: "true"
    ports:
      - "${UITESTS_PORT_EXTERNAL:-9323}:9323"
    volumes:
      - ../ui_tests:/app
    depends_on:
      app:
        condition: service_healthy
      ui:
        condition: service_healthy
    networks:
      - genassist-network-dev

networks:
  genassist-network-dev:
    driver: bridge

volumes:
  pgdata_dev:
    name: genassist_pgdata_dev
  chroma_data_dev:
    name: genassist_chroma_data_dev
  qdrant_data_dev:
    name: genassist_qdrant_data_dev
  app_data_volume_dev:
    name: genassist_app_data_dev
